{{!-- Masonry Portfolio Grid Partial --}}
{{!-- Usage: {{> masonry-portfolio posts=posts}} --}}

<div class="masonry-container">
  {{!-- Loading progress indicator --}}
  <div x-data="masonryGrid()" x-show="isLoading && totalImages > 0"
       class="masonry-loading-progress"
       x-transition:enter="transition ease-out duration-300"
       x-transition:enter-start="opacity-0 transform translate-y-2"
       x-transition:enter-end="opacity-100 transform translate-y-0"
       x-transition:leave="transition ease-in duration-200"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0">
    Loading images... <span x-text="loadingProgress"></span>%
  </div>

  <div class="masonry-portfolio"
       x-data="masonryGrid()"
       x-init="init()"
       :class="{ 'masonry-js-enabled': isInitialized, 'masonry-loading': isLoading }">
    {{#foreach posts}}
      <article class="masonry-item {{#if feature_image}}has-image{{/if}}"
               itemscope
               itemtype="http://schema.org/Article">

        {{#if feature_image}}
          <a href="{{url}}" class="block" aria-label="View {{title}}">
            <picture class="masonry-image">
              {{!-- Generate responsive images using Ghost's img_url helper --}}
              {{!-- Large screens: full size --}}
              <source media="(min-width: 1024px)"
                      srcset="{{img_url feature_image size='m'}} 600w,
                              {{img_url feature_image size='l'}} 1000w,
                              {{img_url feature_image size='xl'}} 2000w"
                      sizes="(min-width: 1200px) 400px, 33vw">

              {{!-- Medium screens: 2 columns --}}
              <source media="(min-width: 768px)"
                      srcset="{{img_url feature_image size='s'}} 400w,
                              {{img_url feature_image size='m'}} 600w,
                              {{img_url feature_image size='l'}} 1000w"
                      sizes="50vw">

              {{!-- Small screens: 1 column --}}
              <source media="(max-width: 767px)"
                      srcset="{{img_url feature_image size='s'}} 400w,
                              {{img_url feature_image size='m'}} 600w"
                      sizes="100vw">

              {{!-- Fallback image --}}
              <img src="{{img_url feature_image size='m'}}"
                   alt="{{#if feature_image_alt}}{{feature_image_alt}}{{else}}{{title}}{{/if}}"
                   loading="lazy"
                   decoding="async"
                   itemprop="image"
                   class="masonry-responsive-image"
                   x-on:load="$el.classList.add('loaded')"
                   x-on:error="$el.style.display = 'none'"
                   :class="{ 'masonry-item-loading': isLoading, 'masonry-item-loaded': isLoadingComplete }">
            </picture>

            {{!-- Overlay with post information --}}
            <div class="masonry-overlay opacity-0 hover:opacity-100 transition-opacity duration-300 absolute inset-0 bg-black bg-opacity-50 flex items-end p-4">
              <div class="text-white">
                <h3 class="text-lg font-semibold mb-1" itemprop="headline">{{title}}</h3>
                {{#if excerpt}}
                  <p class="text-sm opacity-90 line-clamp-2">{{excerpt}}</p>
                {{/if}}
                <time class="text-xs opacity-75" datetime="{{date format='YYYY-MM-DD'}}" itemprop="datePublished">
                  {{date format="MMMM DD, YYYY"}}
                </time>
              </div>
            </div>
          </a>
        {{else}}
          {{!-- Text-only post fallback --}}
          <a href="{{url}}" class="block p-6 bg-gray-100 dark:bg-gray-800 rounded-lg min-h-[200px] flex flex-col justify-center">
            <h3 class="text-lg font-semibold mb-2" itemprop="headline">{{title}}</h3>
            {{#if excerpt}}
              <p class="text-sm text-gray-600 dark:text-gray-300 line-clamp-3">{{excerpt}}</p>
            {{/if}}
            <time class="text-xs text-gray-500 mt-auto" datetime="{{date format='YYYY-MM-DD'}}" itemprop="datePublished">
              {{date format="MMMM DD, YYYY"}}
            </time>
          </a>
        {{/if}}
      </article>
    {{/foreach}}
  </div>
</div>

{{!-- Alpine.js enhancement for lazy loading --}}
<script>
document.addEventListener('alpine:init', () => {
  // Enhanced lazy loading with intersection observer
  const images = document.querySelectorAll('.masonry-responsive-image[loading="lazy"]');

  if ('IntersectionObserver' in window) {
    const imageObserver = new IntersectionObserver((entries, observer) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          img.classList.add('loaded');
          observer.unobserve(img);
        }
      });
    }, {
      rootMargin: '50px 0px',
      threshold: 0.1
    });

    images.forEach(img => imageObserver.observe(img));
  }
});
</script>
